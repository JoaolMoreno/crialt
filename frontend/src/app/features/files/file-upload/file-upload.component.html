<div class="file-upload-container">
  <!-- Área de Upload Principal -->
  <div class="upload-area"
       *ngIf="!readonly"
       [class.drag-over]="dragOver"
       [class.disabled]="!projectId || hasActiveUploads"
       (dragover)="onDragOver($event)"
       (dragleave)="onDragLeave($event)"
       (drop)="onDrop($event)"
       (click)="fileInput.click()">

    <div class="upload-icon">
      <mat-icon>cloud_upload</mat-icon>
    </div>

    <div class="upload-text" *ngIf="!hasActiveUploads">
      <h3>Upload de Arquivos</h3>
      <p *ngIf="projectId">Arraste arquivos aqui ou clique para selecionar</p>
      <p *ngIf="!projectId" class="disabled-text">Salve o projeto primeiro para adicionar arquivos</p>
      <small>Suporte para arquivos até {{ maxFileSize / 1024 / 1024 / 1024 }}GB • Upload automático em chunks</small>
    </div>

    <div class="upload-text" *ngIf="hasActiveUploads">
      <h3>Upload em Andamento</h3>
      <p>Aguarde os uploads atuais terminarem</p>
    </div>

    <input #fileInput
           type="file"
           [multiple]="multiple"
           [disabled]="!projectId || hasActiveUploads"
           (change)="onFileSelect($event)"
           style="display: none;">
  </div>

  <!-- Uploads Ativos -->
  <div class="active-uploads" *ngIf="activeUploads.length > 0">
    <h4>Uploads em Progresso</h4>

    <mat-card *ngFor="let upload of activeUploads; trackBy: trackUpload" class="upload-card">
      <mat-card-header>
        <mat-card-title>{{ upload.filename }}</mat-card-title>
        <mat-card-subtitle>
          <span [ngClass]="getStatusClass(upload.status)">
            {{ getStatusText(upload.status) }}
          </span>
        </mat-card-subtitle>

        <button mat-icon-button
                color="warn"
                *ngIf="upload.status === 'uploading'"
                (click)="cancelUpload(upload.uploadId)"
                title="Cancelar upload">
          <mat-icon>close</mat-icon>
        </button>
      </mat-card-header>

      <mat-card-content>
        <!-- Barra de Progresso -->
        <div class="progress-section">
          <mat-progress-bar
            mode="determinate"
            [value]="upload.progress"
            [color]="getProgressColor(upload.status)">
          </mat-progress-bar>

          <div class="progress-info">
            <span class="progress-text">{{ upload.progress.toFixed(1) }}%</span>
          </div>
        </div>

        <!-- Informações de Velocidade -->
        <div class="speed-info" *ngIf="upload.status === 'uploading' && upload.speed">
          <div class="speed-stats">
            <span class="speed">{{ formatSpeed(upload.speed!) }}</span>
            <span class="eta" *ngIf="upload.estimatedTimeRemaining">
              ETA: {{ formatTime(upload.estimatedTimeRemaining!) }}
            </span>
          </div>
        </div>

        <!-- Mensagem de Erro -->
        <div class="error-message" *ngIf="upload.status === 'error'">
          <mat-icon color="warn">error</mat-icon>
          <span>{{ upload.error }}</span>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Resumo Geral -->
    <div class="upload-summary" *ngIf="activeUploads.length > 1">
      <mat-card>
        <mat-card-content>
          <h4>Resumo dos Uploads</h4>
          <div class="summary-stats">
            <span>Total: {{ activeUploads.length }} arquivo(s)</span>
            <span>Progresso Geral: {{ getOverallProgress().toFixed(1) }}%</span>
            <span>Concluídos: {{ getCompletedCount() }}</span>
            <span>Pendentes: {{ getPendingCount() }}</span>
          </div>

          <mat-progress-bar
            mode="determinate"
            [value]="getOverallProgress()"
            color="accent">
          </mat-progress-bar>
        </mat-card-content>
      </mat-card>
    </div>
  </div>

  <!-- Mensagem de Erro -->
  <div class="error-message" *ngIf="error">
    <mat-icon color="warn">error</mat-icon>
    {{ error }}
  </div>

  <!-- Lista de Arquivos Salvos -->
  <div class="files-list" *ngIf="files.length > 0">
    <div *ngIf="files.length > 1" class="batch-actions">
      <mat-checkbox [checked]="allFilesSelected" (change)="selectAllFiles($event.checked)">
        Selecionar todos
      </mat-checkbox>
      <button *ngIf="anyFileSelected" class="btn-padrao" (click)="downloadSelectedFiles()">
        <span class="material-icons">download</span>
        BAIXAR SELECIONADOS
      </button>
      <span *ngIf="anyFileSelected">({{ selectedFiles.size }} selecionado{{ selectedFiles.size > 1 ? 's' : '' }})</span>
    </div>

    <div class="file-item" *ngFor="let file of files">
      <div *ngIf="files.length > 1">
        <mat-checkbox [checked]="isFileSelected(file)" (change)="toggleFileSelection(file, $event.checked)"></mat-checkbox>
      </div>

      <div class="file-info">
        <div class="file-icon">
          <mat-icon>{{ getFileIcon(file.category, file.mime_type) }}</mat-icon>
        </div>

        <div class="file-details">
          <div class="file-name">
            <ng-container *ngIf="editingFile && editingFile.id === file.id && !readonly; else showFileName">
              <input [(ngModel)]="editFileName" name="editFileName" required class="edit-filename-input" />
            </ng-container>
            <ng-template #showFileName>{{ file.original_name }}</ng-template>
          </div>

          <div class="file-meta">
            <span class="file-size">{{ formatFileSize(file.size) }}</span>
            <ng-container *ngIf="editingFile && editingFile.id === file.id && !readonly; else showFileCategory">
              <select [(ngModel)]="editFileCategory" name="editFileCategory" required class="edit-category-select">
                <option *ngFor="let cat of FileCategory | keyvalue" [value]="cat.value">{{ getCategoryLabel(cat.value) }}</option>
              </select>
            </ng-container>
            <ng-template #showFileCategory>
              <span class="file-category">{{ getCategoryLabel(file.category) }}</span>
            </ng-template>
            <span class="file-date">{{ file.created_at | clientTimezoneDate:'short' }}</span>
          </div>

          <div class="file-description" *ngIf="file.description">
            {{ file.description }}
          </div>
        </div>
      </div>

      <div class="file-actions" *ngIf="!(editingFile && editingFile.id === file.id) && !readonly">
        <button mat-icon-button color="accent" type="button" (click)="startEditFile(file)" title="Editar arquivo">
          <mat-icon>edit</mat-icon>
        </button>
        <button mat-icon-button color="primary" type="button" (click)="downloadFile(file)" title="Baixar arquivo">
          <mat-icon>download</mat-icon>
        </button>
        <button mat-icon-button color="warn" type="button" (click)="deleteFile(file)" title="Excluir arquivo">
          <mat-icon>delete</mat-icon>
        </button>
      </div>

      <div class="file-actions" *ngIf="readonly">
        <button mat-icon-button color="primary" type="button" (click)="downloadFile(file)" title="Baixar arquivo">
          <mat-icon>download</mat-icon>
        </button>
      </div>

      <div *ngIf="editingFile && editingFile.id === file.id && !readonly" class="file-edit-actions">
        <button mat-icon-button color="primary" type="button" (click)="saveEditFile()" title="Salvar">
          <mat-icon>check</mat-icon>
        </button>
        <button mat-icon-button color="warn" type="button" (click)="cancelEditFile()" title="Cancelar">
          <mat-icon>close</mat-icon>
        </button>
      </div>
    </div>
  </div>
</div>
