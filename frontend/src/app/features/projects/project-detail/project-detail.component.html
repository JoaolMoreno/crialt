<section class="section-container" *ngIf="project">
  <div class="form-header">
    <div class="header-actions">
      <button class="btn-padrao" (click)="onBack()" style="margin-right: 16px; align-self: flex-start;">
        <span class="material-icons">arrow_back</span> Voltar
      </button>
      <div class="actions" *ngIf="!isClient">
        <button class="btn-secundario btn-edit"
                (click)="onEditProject()">
          <span class="material-icons">edit</span>
          <span class="btn-label">Editar</span>
        </button>
        <button class="btn-secundario btn-pause"
                (click)="onPauseProject()">
          <span class="material-icons">pause_circle</span>
          <span class="btn-label">Pausar</span>
        </button>
        <button class="btn-secundario btn-finish"
                (click)="onFinishProject()">
          <span class="material-icons">check_circle</span>
          <span class="btn-label">Finalizar</span>
        </button>
      </div>
    </div>
    <div class="info">
      <h1>{{ project.name }}</h1>
      <div class="client">Cliente(s):
        <b>
          <ng-container *ngFor="let client of project.clients; let last = last">
            {{ client.name }}<span *ngIf="!last">, </span>
          </ng-container>
        </b>
      </div>
      <div class="value">Valor: <span class="price">{{ project.total_value | currency:project.currency:'symbol':'1.0-0' }}</span></div>
      <div class="status">Status: <span class="status-badge" [ngClass]="statusBadgeClass(project.status)">{{ statusLabel(project.status) }}</span></div>
      <div class="address" *ngIf="project.work_address">
        Endereço: {{ project.work_address.street }}, {{ project.work_address.number }}
        <span *ngIf="project.work_address.complement"> - {{ project.work_address.complement }}</span>,
        {{ project.work_address.neighborhood }}, {{ project.work_address.city }} - {{ project.work_address.state }}
        <span *ngIf="project.work_address.zip_code"> ({{ project.work_address.zip_code }})</span>
        <span *ngIf="project.work_address.reference"> - Ref: {{ project.work_address.reference }}</span>
      </div>
    </div>
  </div>
  <div class="progress-bar-wrapper">
    <app-progress-bar [progress]="progress"></app-progress-bar>
    <span class="progress-label">{{ progress }}% concluído</span>
  </div>
  <div class="current-stage-widget" *ngIf="currentStage">
    <h3>Etapa Atual</h3>
    <div class="stage-name">{{ currentStage.name }}</div>
    <div class="stage-status">Status: <span class="status-badge" [ngClass]="statusBadgeClass(currentStage.status)">{{ statusLabel(currentStage.status) }}</span></div>
    <div class="stage-dates">
      Início: {{ (currentStage.actual_start_date || currentStage.planned_start_date) | clientTimezoneDate:'shortDate' }} |
      Prazo: {{ (currentStage.actual_end_date || currentStage.planned_end_date) | clientTimezoneDate:'shortDate' }}
    </div>
  </div>
  <nav class="tabs">
    <button [class.active]="activeTab==='overview'" (click)="setTab('overview')">Visão Geral</button>
    <button [class.active]="activeTab==='timeline'" (click)="setTab('timeline')">Timeline</button>
    <button [class.active]="activeTab==='files'" (click)="setTab('files')">Arquivos</button>
    <button [class.active]="activeTab==='finance'" (click)="setTab('finance')">Financeiro</button>
  </nav>
  <div class="tab-content">
    <div *ngIf="activeTab==='overview'">
      <h2>Resumo do Projeto</h2>
      <p>{{ project.description }}</p>
      <div class="dates">
        Início: {{ project.start_date | clientTimezoneDate:'shortDate' }} |
        Prazo estimado: {{ project.estimated_end_date | clientTimezoneDate:'shortDate' }}
        <span *ngIf="project.actual_end_date">| Finalizado: {{ project.actual_end_date | clientTimezoneDate:'shortDate' }}</span>
      </div>
      <div class="scope">
        <span *ngIf="project.scope.total_area">Área: {{ project.scope.total_area }} m²</span>
        <span *ngIf="project.scope.rooms_included?.length"> | Ambientes: {{ project.scope.rooms_included.join(', ') }}</span>
      </div>
      <div class="notes" *ngIf="project.notes">Observações: {{ project.notes }}</div>
      <div class="technical-notes" *ngIf="project.scope.technical_notes">Notas técnicas: {{ project.scope.technical_notes }}</div>
    </div>
    <div *ngIf="activeTab==='timeline'">
      <h2>Timeline das Etapas</h2>
      <app-project-timeline
        [projectId]="project.id"
        [stages]="project.stages">
      </app-project-timeline>
    </div>
    <div *ngIf="activeTab==='files'">
      <h2>Arquivos do Projeto</h2>
      <app-file-upload [projectId]="project.id" [readonly]="true"></app-file-upload>
    </div>
    <div *ngIf="activeTab==='finance'">
      <h2>Financeiro</h2>
      <table class="finance-table">
        <thead>
          <tr>
            <th>Descrição</th>
            <th>Valor</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>Valor Total</td>
            <td class="price">{{ project.total_value | currency:project.currency:'symbol':'1.0-0' }}</td>
            <td>{{ project.status === 'completed' ? 'Pago' : 'Em aberto' }}</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</section>
<app-loading-spinner *ngIf="loading"></app-loading-spinner>
<div *ngIf="error" class="error-message">{{ error }}</div>
