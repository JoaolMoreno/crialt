<section class="project-list-section">
  <h1>Projetos</h1>
  <div class="project-list-actions">
    <button class="btn-padrao" (click)="onNewProject()">
      <span class="material-icons">add_circle</span> Novo Projeto
    </button>
    <input type="text" placeholder="Buscar por nome, cliente ou etapa..." [(ngModel)]="searchQuery" class="search-input" (input)="applyFilters()" />
    <select [(ngModel)]="selectedStatus" class="filter-select" (change)="applyFilters()">
      <option value="">Todos os status</option>
      <option value="in_progress">Em andamento</option>
      <option value="paused">Pausado</option>
      <option value="completed">Concluído</option>
    </select>
    <select [(ngModel)]="selectedClient" class="filter-select" (change)="applyFilters()">
      <option value="">Todos os clientes</option>
      <option *ngFor="let client of clients" [value]="client.id">{{ client.name }}</option>
    </select>
    <input type="month" [(ngModel)]="selectedPeriod" class="filter-select" (change)="applyFilters()" />
    <select [(ngModel)]="selectedStage" class="filter-select" (change)="applyFilters()">
      <option value="">Todas as etapas</option>
      <option *ngFor="let stage of stages" [value]="stage.id">{{ stage.name }}</option>
    </select>
    <input type="number" [(ngModel)]="selectedValue" class="filter-select" placeholder="Valor mínimo" (input)="applyFilters()" />
    <button class="btn-padrao" (click)="export('pdf')">
      <span class="material-icons">download</span> Exportar
    </button>
  </div>

  <div class="view-toggle">
    <button class="btn-padrao" [class.active]="viewMode==='list'" (click)="setViewMode('list')">
      <span class="material-icons">table_rows</span> Lista
    </button>
    <button class="btn-padrao" [class.active]="viewMode==='grid'" (click)="setViewMode('grid')">
      <span class="material-icons">grid_view</span> Grid
    </button>
  </div>

  <app-loading-spinner *ngIf="loading"></app-loading-spinner>
  <div *ngIf="error" class="error-message">{{ error }}</div>

  <div *ngIf="viewMode==='grid' && !loading && filteredProjects.length" class="project-grid">
    <app-project-card
      *ngFor="let project of paginatedProjects"
      [project]="project"
      [progress]="getProjectProgress(project)"
    ></app-project-card>
  </div>

  <div class="batch-actions" *ngIf="selectedProjects.length">
    <button class="btn-padrao" (click)="export('pdf')"><span class="material-icons">download</span> Exportar Selecionados (PDF)</button>
    <button class="btn-padrao" (click)="export('excel')"><span class="material-icons">download</span> Exportar Selecionados (Excel)</button>
    <select [(ngModel)]="batchStatus" class="filter-select">
      <option value="">Alterar status para...</option>
      <option value="in_progress">Em andamento</option>
      <option value="paused">Pausado</option>
      <option value="completed">Concluído</option>
    </select>
    <button class="btn-padrao" (click)="updateSelectedProjectsStatus(batchStatus)" [disabled]="!batchStatus"><span class="material-icons">sync</span> Atualizar Status</button>
  </div>
  <table class="project-table" *ngIf="viewMode==='list' && !loading && filteredProjects.length">
    <thead>
      <tr>
        <th><input type="checkbox" (change)="toggleSelectAll($event)" /></th>
        <th (click)="sortBy('name')" style="cursor:pointer">Projeto <span *ngIf="sortColumn==='name'">{{sortDirection==='asc'?'▲':'▼'}}</span></th>
        <th (click)="sortBy('client')" style="cursor:pointer">Cliente <span *ngIf="sortColumn==='client'">{{sortDirection==='asc'?'▲':'▼'}}</span></th>
        <th (click)="sortBy('status')" style="cursor:pointer">Status <span *ngIf="sortColumn==='status'">{{sortDirection==='asc'?'▲':'▼'}}</span></th>
        <th (click)="sortBy('stage')" style="cursor:pointer">Etapa Atual <span *ngIf="sortColumn==='stage'">{{sortDirection==='asc'?'▲':'▼'}}</span></th>
        <th (click)="sortBy('value')" style="cursor:pointer">Valor <span *ngIf="sortColumn==='value'">{{sortDirection==='asc'?'▲':'▼'}}</span></th>
        <th (click)="sortBy('created_at')" style="cursor:pointer">Data de Criação <span *ngIf="sortColumn==='created_at'">{{sortDirection==='asc'?'▲':'▼'}}</span></th>
        <th>Ações</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let project of paginatedProjects">
        <td><input type="checkbox" [checked]="selectedProjects.includes(project.id)" (change)="toggleProjectSelection(project.id)" /></td>
        <td>{{ project.name }}</td>
        <td>{{ project.clients[0]?.name }}</td>
        <td>{{ project.status }}</td>
        <td>{{ getCurrentStage(project)?.name }}</td>
        <td class="price">{{ project.total_value | currency:'BRL':'symbol':'1.0-0' }}</td>
        <td>{{ project.created_at | date:'shortDate' }}</td>
        <td>
          <button class="action-btn" (click)="onEditProject(project)" [disabled]="!isAdmin" title="Editar projeto"><span class="material-icons">edit</span></button>
          <button class="action-btn" (click)="onViewProject(project)" title="Visualizar projeto"><span class="material-icons">visibility</span></button>
          <button class="action-btn" (click)="onToggleStatus(project)" [disabled]="!isAdmin" [title]="project.status === 'paused' ? 'Retomar projeto' : 'Pausar projeto'">
            <span class="material-icons">pause_circle</span>
          </button>
        </td>
      </tr>
    </tbody>
  </table>

  <div *ngIf="!loading && !filteredProjects.length" class="empty-message">
    Nenhum projeto encontrado.
  </div>

  <!-- Paginação -->
  <div class="pagination" *ngIf="totalPages > 1">
    <button (click)="goToPage(currentPage - 1)" [disabled]="currentPage === 1">Anterior</button>
    <span>Página {{ currentPage }} de {{ totalPages }}</span>
    <button (click)="goToPage(currentPage + 1)" [disabled]="currentPage === totalPages">Próxima</button>
  </div>
</section>
