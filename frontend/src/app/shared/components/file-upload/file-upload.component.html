<div class="file-upload-container">
  <div class="upload-area"
       *ngIf="!readonly"
       [class.drag-over]="dragOver"
       [class.disabled]="!projectId"
       (dragover)="onDragOver($event)"
       (dragleave)="onDragLeave($event)"
       (drop)="onDrop($event)"
       (click)="fileInput.click()">

    <div class="upload-icon">
      <span class="material-icons">cloud_upload</span>
    </div>

    <div class="upload-text" *ngIf="!uploading">
      <p *ngIf="projectId">Clique ou arraste arquivos aqui</p>
      <p *ngIf="!projectId" class="disabled-text">Salve o projeto primeiro para adicionar arquivos</p>
      <small>MÃ¡ximo {{ maxFileSize / 1024 / 1024 }}MB por arquivo</small>
    </div>

    <div class="upload-loading" *ngIf="uploading">
      <app-loading-spinner></app-loading-spinner>
      <p>Fazendo upload...</p>
    </div>

    <input #fileInput
           type="file"
           [multiple]="multiple"
           [disabled]="!projectId"
           (change)="onFileSelect($event)"
           style="display: none;">
  </div>

  <div class="error-message" *ngIf="error">
    {{ error }}
  </div>

  <div class="files-list" *ngIf="files.length > 0">
    <div *ngIf="files.length > 1" class="files-list-toolbar" style="display:flex;align-items:center;margin-bottom:8px;gap:16px;">
      <mat-checkbox [checked]="allFilesSelected" (change)="selectAllFiles($event.checked)">
        Selecionar todos
      </mat-checkbox>
      <button class="btn-padrao" (click)="downloadSelectedFiles()" [disabled]="!anyFileSelected">
        BAIXAR SELECIONADOS
      </button>
      <span *ngIf="anyFileSelected">({{ selectedFiles.size }} selecionado{{ selectedFiles.size > 1 ? 's' : '' }})</span>
    </div>
    <div class="file-item" *ngFor="let file of files">
      <div style="display:flex;align-items:flex-start;">
        <div *ngIf="files.length > 1" style="margin-right:8px;">
          <mat-checkbox [checked]="isFileSelected(file)" (change)="toggleFileSelection(file, $event.checked)"></mat-checkbox>
        </div>
        <div class="file-info">
          <div class="file-icon">
            <span class="material-icons">
              {{ getFileIcon(file.category, file.mime_type) }}
            </span>
          </div>
          <div class="file-details">
            <div class="file-name">
              <ng-container *ngIf="editingFile && editingFile.id === file.id && !readonly; else showFileName">
                <input [(ngModel)]="editFileName" name="editFileName" required style="width:320px; max-width:100%; margin-right:8px;" />
              </ng-container>
              <ng-template #showFileName>{{ file.original_name }}</ng-template>
            </div>
            <div class="file-meta">
              <span class="file-size">{{ formatFileSize(file.size) }}</span>
              <ng-container *ngIf="editingFile && editingFile.id === file.id && !readonly; else showFileCategory">
                <select [(ngModel)]="editFileCategory" name="editFileCategory" required style="margin-right:8px;">
                  <option *ngFor="let cat of FileCategory | keyvalue" [value]="cat.value">{{ getCategoryLabel(cat.value) }}</option>
                </select>
              </ng-container>
              <ng-template #showFileCategory>
                <span class="file-category">{{ getCategoryLabel(file.category) }}</span>
              </ng-template>
              <span class="file-date">{{ file.created_at | clientTimezoneDate:'short' }}</span>
            </div>
            <div class="file-description" *ngIf="file.description">
              {{ file.description }}
            </div>
          </div>
        </div>
      </div>
      <div class="file-actions" *ngIf="!(editingFile && editingFile.id === file.id) && !readonly">
        <button mat-icon-button
                type="button"
                color="accent"
                (click)="startEditFile(file)"
                title="Editar arquivo">
          <mat-icon>edit</mat-icon>
        </button>
        <button mat-icon-button
                type="button"
                color="primary"
                (click)="downloadFile(file)"
                title="Baixar arquivo">
          <mat-icon>download</mat-icon>
        </button>
        <button mat-icon-button
                type="button"
                color="warn"
                (click)="deleteFile(file)"
                title="Excluir arquivo">
          <mat-icon>delete</mat-icon>
        </button>
      </div>
      <div class="file-actions" *ngIf="readonly">
        <button mat-icon-button
                type="button"
                color="primary"
                (click)="downloadFile(file)"
                title="Baixar arquivo">
          <mat-icon>download</mat-icon>
        </button>
      </div>
      <div *ngIf="editingFile && editingFile.id === file.id && !readonly" class="file-edit-form">
        <form (ngSubmit)="saveEditFile()" class="file-edit-inline-form">
          <button mat-icon-button color="primary" type="submit" title="Salvar"><mat-icon>check</mat-icon></button>
          <button mat-icon-button color="warn" type="button" (click)="cancelEditFile()" title="Cancelar"><mat-icon>close</mat-icon></button>
        </form>
      </div>
    </div>
  </div>
</div>
